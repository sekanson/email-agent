name: Test Email Labeling

on:
  push:
    branches: [master]
  workflow_dispatch:  # Manual trigger

jobs:
  test-labeling:
    runs-on: ubuntu-latest
    # Wait for Vercel deployment to complete
    # Vercel typically deploys in 1-2 minutes
    
    steps:
      - name: Wait for Vercel deployment
        run: sleep 180  # 3 minutes for deployment
      
      - name: Send test email via API
        id: send-email
        run: |
          TEST_ID="gh-test-${{ github.run_id }}"
          echo "test_id=$TEST_ID" >> $GITHUB_OUTPUT
          
          # Trigger test via webhook (we'll create this endpoint)
          RESPONSE=$(curl -s -X POST \
            "${{ secrets.ZENO_API_URL }}/api/test/trigger" \
            -H "Authorization: Bearer ${{ secrets.TEST_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"testId\": \"$TEST_ID\"}")
          
          echo "Response: $RESPONSE"
          echo "message_id=$(echo $RESPONSE | jq -r '.messageId')" >> $GITHUB_OUTPUT
      
      - name: Wait for processing
        run: sleep 150  # 2.5 minutes for cron to run
      
      - name: Check labeling result
        run: |
          RESULT=$(curl -s \
            "${{ secrets.ZENO_API_URL }}/api/test/verify?testId=${{ steps.send-email.outputs.test_id }}" \
            -H "Authorization: Bearer ${{ secrets.TEST_API_KEY }}")
          
          echo "Result: $RESULT"
          
          LABELED=$(echo $RESULT | jq -r '.labeled')
          if [ "$LABELED" != "true" ]; then
            echo "❌ Test failed - email was not labeled"
            exit 1
          fi
          
          echo "✅ Test passed - email was labeled correctly"
          echo "Label: $(echo $RESULT | jq -r '.label')"
